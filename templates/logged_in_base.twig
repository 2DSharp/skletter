<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}{% endblock %}</title>
    {{ include('base_includes.twig') }}
    <script src="https://kit.fontawesome.com/7bd7bcf156.js" crossorigin="anonymous"></script>
    <link href="{{ server.css_assets }}/web-platform.css" rel="stylesheet">
    <script>
        var onFocus = -1;

        function scrollList() {
            var list = document.getElementById('suggestions-ul'); // targets the <ul>
            var first = list.firstChild; // targets the first <li>
            var maininput = document.getElementById('search-box');  // targets the input, which triggers the functions populating the list
            document.onkeydown = function (e) { // listen to keyboard events
                switch (e.key) {
                    case 38: // if the UP key is pressed
                        if (document.activeElement == (maininput || first)) {
                            break;
                        } // stop the script if the focus is on the input or first element
                        else {
                            document.activeElement.parentNode.previousSibling.firstChild.focus();
                        } // select the element before the current, and focus it
                        break;
                    case 40: // if the DOWN key is pressed
                        if (document.activeElement == maininput) {
                            first.firstChild.focus();
                        } // if the currently focused element is the main input --> focus the first <li>
                        else {
                            document.activeElement.parentNode.nextSibling.firstChild.focus();
                        } // target the currently focused element -> <a>, go up a node -> <li>, select the next node, go down a node and focus it
                        break;
                }
            }
        }

        function checkKey(e) {
            if (e.key == '40') {
                document.getElementById("suggest-" + 0).focus();
                onFocus = 0;
            }

        }

        function moveFocus(e, i) {
            if (e.key == '40') {
                document.getElementById("suggest-" + i + 1).focus();
                onFocus = i;
            } else if (e.key == '38') {
                document.getElementById("suggest-" + i - 1).focus();
                onFocus = i;
            }
        }

        function showResult(str) {
            if (str.length == 0) {
                document.getElementById("suggestions").innerHTML = "";
                document.getElementById("suggestions").style.display = "none";

                return;
            }
            if (window.XMLHttpRequest) {
                // code for IE7+, Firefox, Chrome, Opera, Safari
                xmlhttp = new XMLHttpRequest();
            } else {  // code for IE6, IE5
                xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
            }
            xmlhttp.onreadystatechange = function () {

                if (this.readyState == 4 && this.status == 200) {
                    document.getElementById("suggestions").style.display = "block";
                    document.getElementById("main-search").onkeydown = checkKey;
                    console.log(this.responseText)
                    var result = JSON.parse(this.responseText);
                    var suggestion = "<ul id='suggestions-ul'>";
                    var i = 0;
                    for (var k in result) {
                        data = (result[k]);
                        //var data =  JSON.parse((JSON.parse(result[k]).user).data)
                        //console.log(JSON.parse(user.data));
                        //console.log(JSON.parse((result[k]).user).data.name);
                        var answer = (data.data.name);
                        var find = str;
                        var re = new RegExp(find, 'ig');

                        //var bolded = answer.replace(re, '<b>' + find + '</b>');
                        //var bolded= replaceAllanswer.replace(str/g, "<b>" + str + "</b>")
                        //console.log(bolded)
                        suggestion += "<li tabindex='" + i + "' onkeydown='moveFocus(e," + i + ")' class='suggest-list' id='suggest-" + i + "' >" + answer + "</li>";
                        i++;
                    }

                    //console.log(result.user)
                    //    console.log(result)

                    document.getElementById("suggestions").innerHTML = suggestion + "</ul>";
                    scrollList();
                }
            }
            xmlhttp.open("GET", "search?q=" + str, true);
            xmlhttp.send();
        }
    </script>
    {% block head %}
    {% endblock %}
</head>
<body>
<div id="header">
    <div class="header-wrapper">
        <div class="row">
            <div class="column">
                <div class="header-block head-text">

                </div>
            </div>

            <div class="column central-block">
                <div class="search-block">
                    <i class="fas fa-search embed-icon"></i>
                    <input type="text" onkeyup="showResult(this.value)" id="main-search" class="search-box"
                           placeholder="Search Skletter">

                </div>
                <div id="suggestions"></div>
            </div>

            <div class="column" style="align-items: flex-end">
                <div style="margin-left: 50px">
                    <span class="fa-stack nav-icon" style="vertical-align: top;">
                      <i class="fas fa-circle fa-stack-2x stack-bg"></i>
                      <i class="fas fa-comments fa-stack-1x fa-inverse stacked-ico"></i>
                    </span>
                    <span class="fa-stack nav-icon" style="vertical-align: top;">
                      <i class="fas fa-circle fa-stack-2x stack-bg"></i>
                      <i class="fas fa-bell fa-stack-1x fa-inverse"></i>
                    </span>
                    <span class="fa-stack nav-icon" style="vertical-align: top;">
                      <i class="fas fa-circle fa-stack-2x stack-bg"></i>
                      <i class="fas fa-ellipsis-h fa-stack-1x fa-inverse"></i>
                    </span>
                </div>

            </div>
        </div>
    </div>

</div>

<div id="content">
    <div id="main-container" class="container">

        <div class='page-wrapper'>
            <div class='row'>
                <div class='column main-left'>
                    {{ include('pieces/action_menu.twig') }}
                </div>
                <div class='column main-center'>
                    {% block content %}{% endblock %}
                </div>

                <div class='column'>
                    <div class='right-block'>
                        <div class="row">
                            {% block footer %}
                                &copy; Skletter.
                            {% endblock %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% block costly_imports %}
{% endblock %}
</body>
</html>
